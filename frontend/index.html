<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDR-List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flag-icon {
            width: 24px;
            height: auto;
            margin-right: 5px;
        }
        .receiver {
            -webkit-animation: scale-up-blur 1s cubic-bezier(0.550, 0.085, 0.680, 0.530) both;
            animation: scale-up-blur 1s cubic-bezier(0.550, 0.085, 0.680, 0.530) both;
        }

        .receiver-added {
            transition: height 1s ease 0s;
            height: 125px;
        }
        /* Zoom-in effect on hover */
        .receiver-added:hover {
            cursor: pointer;
            height: 150px;
        }
        @-webkit-keyframes scale-up-blur {
            0% {
                -webkit-transform: scale(0.5);
                transform: scale(0.5);
                -webkit-filter: blur(12px);
                filter: blur(12px);
                opacity: 0;
            }
            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
                -webkit-filter: blur(0px);
                filter: blur(0px);
                opacity: 1;
            }
        }
        @keyframes scale-up-blur {
            0% {
                -webkit-transform: scale(0.5);
                transform: scale(0.5);
                -webkit-filter: blur(12px);
                filter: blur(12px);
                opacity: 0;
            }
            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
                -webkit-filter: blur(0px);
                filter: blur(0px);
                opacity: 1;
            }
        }

        
    </style>
</head>
<body class="flex items-center justify-center bg-slate-900 border-0">

    <div class="w-full flex justify-center py-4 bg-slate-800 fixed top-0 z-10">
    <select id="bandFilter" class="my-5 p-2 m-6 rounded border bg-white">
        <option value="any">Any</option>
        <option value="VLF">VLF</option>
        <option value="LF">LF</option>
        <option value="MW">MW</option>
        <option value="0_30">0 - 30 MHz</option>
        <option value="80m">80m</option>
        <option value="40m">40m</option>
        <option value="20m">20m</option>
        <option value="10m">10m</option>
        <option value="6m">6m</option>
        <option value="2m">2m</option>
    </select>
</div>
    
    <div id="receiverList"  class="pt-28">
    </div>
    <script>

        const bandRanges = {
            "any": null,
            "VLF": {min: 0, max: 30000},
            "LF": {min: 30000, max: 300000},
            "MW": {min: 530000, max: 1720000},
            "0_30": {min: 0, max: 30000000},
            "80m": {min: 3500000, max: 4000000},
            "40m": {min: 7000000, max: 7200000},
            "20m": {min: 14000000, max: 14350000},
            "10m": {min: 28000000, max: 29700000},
            "6m": {min: 50000000, max: 54000000},
            "2m": {min: 144000000, max: 146000000},
        };


        let queriedReceivers = {}; // Object to store queried receivers

        function fetchCountryFlag(ip, receiverElement) {
            fetch(`https://api.country.is/${ip}`)
                .then(response => response.json())
                .then(data => {
                    const country = data.country;
                    const flagElement = document.createElement('img');
                    flagElement.className = 'flag-icon m-2 w-12 rounded';
                    flagElement.src = `https://flagcdn.com/${country.toLowerCase()}.svg`;
                    flagElement.alt = country;
                    receiverElement.querySelector('.flex.items-center.bg-gradient-to-r.from-gray-800.to-black.text-white').prepend(flagElement);
                })
                .catch(error => console.error('Error fetching country flag:', error));
        }

        function redirectToIpPort(ip, port) {
            window.location.href = `http://${ip}:${port}`;
        }

        
        // Function to redirect to the receiver
        function redirectToReceiver() {
            const receiverId = this.id.split('_')[1];
            const receiverData = data[receiverId];
            redirectToIpPort(receiverData.ip, receiverData.port);
        }

        function fetchWebSDRData() {
            fetch('https://sdr-list.xyz/api/get_websdrs')
                .then(response => response.json())
                .then(data => {
                    const receiverListElement = document.getElementById("receiverList");
                    let currentReceivers = { ...queriedReceivers };
                    
                    // Sort receiver data based on number of users
                    const sortedReceiverData = Object.values(data).sort((a, b) => b.users - a.users);

                    sortedReceiverData.forEach((receiverData, index) => {
                        const receiverName = receiverData.name.slice(0, 14);
                        const receiverId = receiverData.id;
                        
                        if (!queriedReceivers[receiverId]) { // Check if receiver is not already queried
                            queriedReceivers[receiverId] = { ip: receiverData.ip, center_frequency: receiverData.center_frequency, bandwidth: receiverData.bandwidth }; // Mark receiver as queried and store its IP
                            const receiverElement = document.createElement("div");
                            receiverElement.className = "receiver bg-zinc-100 w-80 flex flex-col rounded border-solid border-2 border-gray-600 mt-5 ";
                            receiverElement.id = `receivercard_${receiverId}`;

                            receiverElement.innerHTML = `
                                <div class="receiver-added flex items-center bg-gradient-to-r from-gray-800 to-black text-white ">
                                    <div class="ml-2">
                                        <div class="flex items-center h-6">
                                            <div class="w-8  flex items-center justify-center">
                                                <i class="fa-solid fa-house-circle-exclamation"></i>
                                            </div>
                                            <p class="ml-2">${receiverName}</p>
                                        </div>
                                        <div class="flex items-center h-6">
                                            <div class="w-8  flex items-center justify-center">
                                                <i class="fa-solid fa-satellite-dish"></i>
                                            </div>
                                            <p class="ml-2">${receiverData.antenna}</p>
                                        </div>
                                        <div class="flex items-center h-6">
                                            <div class="w-8  flex items-center justify-center">
                                                <i class="fa-solid fa-arrows-left-right"></i>
                                            </div>
                                            <p class="ml-2">${receiverData.center_frequency - (receiverData.bandwidth / 2)} - ${(receiverData.center_frequency + (receiverData.bandwidth / 2)) / 1000} kHz</p>
                                        </div>
                                        <div class="flex items-center h-6">
                                            <div class="w-8 flex items-center justify-center">
                                                <i class="fa-regular fa-user"></i>
                                            </div>
                                            <p class="ml-2" id="users_${receiverId}">${receiverData.users}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            receiverListElement.appendChild(receiverElement);
                            fetchCountryFlag(receiverData.ip, receiverElement); // Fetch country flag
                            setTimeout(() => receiverElement.classList.add('receiver'), index * 100); // Add class with animation delay
                            
                            // Add click event listener to redirect to IP:Port
                            receiverElement.addEventListener('click', () => redirectToIpPort(receiverData.ip, receiverData.port));
                        } else { // Update existing receiver data
                            const receiverElement = receiverListElement.querySelector(`#users_${receiverId}`);
                            if (receiverElement) {
                                receiverElement.innerText = receiverData.users; // Update user count
                            }
                            const queriedReceiver = queriedReceivers[receiverId];
                            // Check if IP address has changed
                            if (receiverData.ip !== queriedReceiver.ip) {
                                queriedReceiver.ip = receiverData.ip; // Update stored IP address
                                const receiverCardElement = document.getElementById(`receivercard_${receiverId}`);
                                // Update click event listener to use the new IP address
                                receiverCardElement.removeEventListener('click', redirectToIpPort);
                                receiverCardElement.addEventListener('click', () => redirectToIpPort(receiverData.ip, receiverData.port));
                            }
                                                        
                        }
                        // Remove the receiver from currentReceivers if it's found in the new data
                        delete currentReceivers[receiverId];
                    });

                    // Remove receivers that are no longer present in the data
                    for (const receiverId in currentReceivers) {
                        if (currentReceivers.hasOwnProperty(receiverId)) {
                            const receiverElement = receiverListElement.querySelector(`#users_${receiverId}`).closest('.receiver');
                            if (receiverElement) {
                                receiverElement.classList.remove('receiver'); // Remove animation class
                                setTimeout(() => receiverElement.remove(), 1000); // Delay removal to allow animation
                                delete queriedReceivers[receiverId];
                            }
                        }
                    }

                })
                .catch(error => console.error('Error fetching WebSDR data:', error));
        }

        function filterReceiversByBand() {
            const selectedBand = document.getElementById('bandFilter').value;
            const bandRange = bandRanges[selectedBand];
            const receivers = document.querySelectorAll('.receiver');

            receivers.forEach(receiver => {
                const receiverId = receiver.id.split('_')[1];
                const receiverData = queriedReceivers[receiverId];
                
                const lowerBound = receiverData.center_frequency - (receiverData.bandwidth / 2);
                const upperBound = receiverData.center_frequency + (receiverData.bandwidth / 2);

                // Check if any part of the receiver's range overlaps with the selected band
                const overlapsWithBand = selectedBand === "any" || 
                                        (upperBound > bandRange.min && lowerBound < bandRange.max);

                receiver.style.display = overlapsWithBand ? '' : 'none';
            });
        }


        document.getElementById('bandFilter').addEventListener('change', filterReceiversByBand);



        // Fetch data initially when the page loads
        fetchWebSDRData();

        // Update data every 10 seconds
        setInterval(fetchWebSDRData, 10000);

        
    </script>
</body>
</html>
